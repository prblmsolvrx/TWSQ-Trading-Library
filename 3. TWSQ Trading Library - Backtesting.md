# Backtesting

Backtesting is a crucial feature of the TWSQ Trading Library that allows you to test your strategies on historical data before deploying them in live trading.

## Running a Backtest

To run a backtest, use the `run_backtest` method of your strategy class:

```python
result = ETHDCA.run_backtest(start_ts='20210101')
```

## Backtest Parameters

The `run_backtest` method accepts several parameters:

- `start_ts`: Start time of the backtest (default is 365 days prior to `end_ts`)
- `end_ts`: End time of the backtest (default is current time)
- `freq`: Rebalance frequency (default is '1h')
- `name`: Name of the strategy (used for logging and saving results)
- `taker_fee`: Commissions for market orders (default is Kraken's fee of 26 bps)
- `maker_fee`: Commissions for limit orders (default is Kraken's fee of 16 bps)
- `slip`: Slippage for market orders (default is 10 bps)

Example with custom parameters:

```python
result = ETHDCA.run_backtest(
    start_ts='20210101',
    end_ts='20211231',
    freq='1d',
    name='ETHDCA_2021',
    taker_fee=0.0025,
    maker_fee=0.0015,
    slip=0.001
)
```

## Backtest Logic

The backtest iterates through historical data at the specified frequency:

1. Fill any outstanding limit orders
2. Call the strategy's `rebalance` function
3. Fill any market orders created by `rebalance`
4. Move to the next time step

Market orders are filled immediately at the current price plus slippage. Limit orders are checked for filling at each time step based on the high and low prices of the bar.

## PnL Calculation

The backtest PnL is the aggregate PnL of all trades executed by the strategy. There's no notion of "budget" or "equity capital", so PnL can be infinitely negative in the backtest.

## Shorting

Shorting is currently permitted in backtests. Work is ongoing to implement shorting in live trading as well.

## Output

Backtest results are saved in `MyTWSQ/alphas/{strategy_name}/backtest/` as two CSV files:

1. `pos_pnl.csv`: Contains positions and PnL information
   - Columns: Date, asset positions, port_val, pnl
2. `orders.csv`: Contains all order information
   - Columns: strategy, symbol, qty, side, sec_type, limit_price, type, custom_id, id, status, qty_filled, ntn_filled, avg_px, fee, start_ts, arrival_px, base, quote, end_ts

You can also access these results through the `result` object returned by `run_backtest`:

```python
positions_and_pnl = result.pos_pnl
orders = result.orders
```

## Multiple Backtests

You can run multiple backtests with different parameters to compare results:

```python
net = ETHDCA.run_backtest(start_ts='20210101', name='Net', freq='1d')
gross = ETHDCA.run_backtest(start_ts='20210101', name='Gross', freq='1d', 
                            taker_fee=0, maker_fee=0, slip=0)
```

This backtesting guide provides a comprehensive overview of how to use the backtesting capabilities of the TWSQ Trading Library. It covers running backtests, understanding the backtest logic, and interpreting the results.